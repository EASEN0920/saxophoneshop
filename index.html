<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜ä¹‹çª©æ–‡å‰µç©ºé–“ç™»è¨˜è¡¨</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for browser JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // ğŸš¨ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase å°ˆæ¡ˆè³‡è¨Š ğŸš¨
        // ==========================================
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // åµæ¸¬æ˜¯å¦å·²å¡«å¯«è¨­å®š
        const isConfigValid = firebaseConfig && firebaseConfig.apiKey !== "";
        
        // åƒ…åœ¨æœ‰æ•ˆæ™‚åˆå§‹åŒ–
        if (isConfigValid) {
            firebase.initializeApp(firebaseConfig);
        }

        const CLASSROOM_TYPES = {
            LARGE: 'å¤§æ•™å®¤',
            SMALL: 'å°æ•™å®¤'
        };

        const BANK_INFO = {
            name: "å˜ä¹‹çª©æ–‡å‰µç©ºé–“",
            bank: "å°ç£éŠ€è¡Œ (004)",
            account: "123-456-789012",
            remind: "åŒ¯æ¬¾å¾Œè«‹æä¾›å¸³è™Ÿæœ«äº”ç¢¼ä»¥åˆ©å°å¸³ã€‚ç®¡ç†å“¡ç¢ºèªåŒ¯æ¬¾å¾Œï¼Œç³»çµ±å°‡è‡ªå‹•å¯„ç™¼ç¢ºèªä¿¡ä¸¦åŒæ­¥è‡³æ—¥æ›†ã€‚"
        };

        const Icon = ({ name, className }) => {
            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [bookings, setBookings] = useState([]);
            const [step, setStep] = useState(1);
            const [message, setMessage] = useState(null);
            const [formData, setFormData] = useState({
                date: '',
                startTime: '09:00',
                endTime: '10:00',
                roomType: CLASSROOM_TYPES.LARGE,
                name: '',
                phone: '',
                note: ''
            });

            // åˆå§‹åŒ– Auth
            useEffect(() => {
                if (!isConfigValid) {
                    setLoading(false);
                    return;
                }
                const unsubscribe = firebase.auth().onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                    if (u) setFormData(prev => ({ ...prev, name: u.displayName || '' }));
                });
                return () => unsubscribe();
            }, []);

            // ç›£è½é ç´„
            useEffect(() => {
                if (!user || !isConfigValid) return;
                const db = firebase.firestore();
                const unsubscribe = db.collection('bookings')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBookings(data);
                    }, (err) => console.error("Firestore error:", err));
                return () => unsubscribe();
            }, [user]);

            const handleLogin = async () => {
                if (!isConfigValid) {
                    alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š Firebase API Keyï¼");
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await firebase.auth().signInWithPopup(provider);
                } catch (error) {
                    setMessage({ type: 'error', text: 'ç™»å…¥å¤±æ•—ï¼š' + error.message });
                }
            };

            const handleLogout = () => firebase.auth().signOut();

            const calculatePrice = useMemo(() => {
                if (!formData.date || !formData.startTime || !formData.endTime) return 0;
                const startHour = parseInt(formData.startTime.split(':')[0]);
                const endHour = parseInt(formData.endTime.split(':')[0]);
                const duration = endHour - startHour;
                if (duration <= 0) return 0;

                if (formData.roomType === CLASSROOM_TYPES.SMALL) return duration * 350;
                
                const dateObj = new Date(formData.date);
                const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                let total = 0;
                for (let h = startHour; h < endHour; h++) {
                    if (isWeekend) total += 600;
                    else total += (h < 17) ? 500 : 600;
                }
                return total;
            }, [formData]);

            const checkConflict = () => {
                return bookings.some(b => {
                    if (b.date !== formData.date || b.roomType !== formData.roomType) return false;
                    const newStart = parseInt(formData.startTime.replace(':', ''));
                    const newEnd = parseInt(formData.endTime.replace(':', ''));
                    const oldStart = parseInt(b.startTime.replace(':', ''));
                    const oldEnd = parseInt(b.endTime.replace(':', ''));
                    return (newStart < oldEnd && newEnd > oldStart);
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (checkConflict()) {
                    setMessage({ type: 'error', text: 'è©²æ™‚æ®µå·²è¢«ä½”ç”¨ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚' });
                    return;
                }
                try {
                    await firebase.firestore().collection('bookings').add({
                        ...formData,
                        userId: user.uid,
                        userEmail: user.email,
                        price: calculatePrice,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setStep(3);
                } catch (error) {
                    setMessage({ type: 'error', text: 'æäº¤å¤±æ•—ï¼š' + error.message });
                }
            };

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white">
                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    <p className="mt-4 text-indigo-600 font-bold">è¼‰å…¥ç³»çµ±ä¸­...</p>
                </div>
            );

            // è‹¥å°šæœªå¡«å¯«é‡‘é‘°çš„æç¤ºç•«é¢
            if (!isConfigValid) return (
                <div className="h-screen flex items-center justify-center p-6 text-center">
                    <div className="max-w-md bg-amber-50 border border-amber-200 p-8 rounded-2xl shadow-sm">
                        <Icon name="alert-triangle" className="w-12 h-12 text-amber-500 mx-auto mb-4" />
                        <h1 className="text-xl font-bold text-amber-900 mb-2">å°šæœªè¨­å®š Firebase</h1>
                        <p className="text-amber-800 mb-6 text-sm">
                            æ‚¨ç›®å‰çœ‹åˆ°çš„ç©ºç™½æ˜¯å› ç‚ºç¨‹å¼ç¢¼ä¸­çš„ <code>firebaseConfig</code> å°šæœªå¡«å¯«ã€‚<br/>
                            è«‹å‰å¾€ Firebase æ§åˆ¶å°å»ºç«‹å°ˆæ¡ˆä¸¦è¤‡è£½é‡‘é‘°ã€‚
                        </p>
                        <a href="https://console.firebase.google.com/" target="_blank" className="inline-block bg-amber-600 text-white px-6 py-2 rounded-lg font-bold">å‰å¾€ Firebase è¨­å®š</a>
                    </div>
                </div>
            );

            if (!user) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center">
                        <Icon name="home" className="w-16 h-16 text-indigo-600 mx-auto mb-6" />
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">å˜ä¹‹çª©æ–‡å‰µç©ºé–“</h1>
                        <p className="text-gray-600 mb-8">è«‹å…ˆç™»å…¥ Google å¸³è™Ÿä»¥é–‹å§‹é ç´„æ•™å®¤</p>
                        <button onClick={handleLogin} className="w-full py-3 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-3 font-medium hover:bg-gray-50 transition-all">
                            <img src="https://www.google.com/favicon.ico" className="w-5 h-5" alt="Google" />
                            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    <nav className="bg-white shadow-sm p-4 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="home" className="w-6 h-6 text-indigo-600" />
                                <span className="font-bold text-xl">å˜ä¹‹çª©é ç´„ç³»çµ±</span>
                            </div>
                            <button onClick={handleLogout} className="text-gray-500 hover:text-red-500 flex items-center gap-2">
                                <span className="hidden sm:inline text-sm font-medium">{user.displayName}</span>
                                <Icon name="log-out" className="w-5 h-5" />
                            </button>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto p-4 mt-8">
                        <div className="flex justify-center mb-8 gap-4">
                            {[1, 2, 3].map(s => (
                                <div key={s} className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${step >= s ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-400'}`}>{s}</div>
                            ))}
                        </div>

                        {message && (
                            <div className={`mb-4 p-4 rounded-xl flex items-center gap-2 ${message.type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'}`}>
                                <Icon name={message.type === 'error' ? "alert-circle" : "check-circle"} className="w-5 h-5" />
                                {message.text}
                            </div>
                        )}

                        {step === 1 && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="calendar" className="text-indigo-600" /> é¸æ“‡æ™‚æ®µ</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-bold mb-2 text-gray-700">é ç´„æ—¥æœŸ</label>
                                        <input type="date" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all" min={new Date().toISOString().split('T')[0]} value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="block text-sm font-bold mb-2 text-gray-700">é–‹å§‹æ™‚é–“</label>
                                            <select className="w-full p-3 border rounded-xl" value={formData.startTime} onChange={e => setFormData({...formData, startTime: e.target.value})}>
                                                {Array.from({length:14}, (_,i)=>i+8).map(h => <option key={h} value={`${h.toString().padStart(2,'0')}:00`}>{h}:00</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-sm font-bold mb-2 text-gray-700">çµæŸæ™‚é–“</label>
                                            <select className="w-full p-3 border rounded-xl" value={formData.endTime} onChange={e => setFormData({...formData, endTime: e.target.value})}>
                                                {Array.from({length:14}, (_,i)=>i+9).map(h => <option key={h} value={`${h.toString().padStart(2,'0')}:00`}>{h}:00</option>)}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={()=>setFormData({...formData, roomType: CLASSROOM_TYPES.LARGE})} className={`p-4 border-2 rounded-xl text-left transition-all ${formData.roomType === CLASSROOM_TYPES.LARGE ? 'border-indigo-600 bg-indigo-50' : 'border-gray-100 hover:border-gray-200'}`}>
                                        <p className="font-bold text-gray-800">å¤§æ•™å®¤</p>
                                        <p className="text-xs text-gray-500 mt-1">å¹³æ—¥ $500/hr</p>
                                        <p className="text-xs text-gray-500">17:00å¾ŒåŠå‡æ—¥ $600/hr</p>
                                    </button>
                                    <button onClick={()=>setFormData({...formData, roomType: CLASSROOM_TYPES.SMALL})} className={`p-4 border-2 rounded-xl text-left transition-all ${formData.roomType === CLASSROOM_TYPES.SMALL ? 'border-indigo-600 bg-indigo-50' : 'border-gray-100 hover:border-gray-200'}`}>
                                        <p className="font-bold text-gray-800">å°æ•™å®¤</p>
                                        <p className="text-xs text-gray-500 mt-1">å‡ä¸€åƒ¹ $350/hr</p>
                                        <p className="text-xs text-gray-500">ä¸åˆ†æ™‚æ®µèˆ‡å¹³å‡æ—¥</p>
                                    </button>
                                </div>
                                <button disabled={!formData.date} onClick={()=>setStep(2)} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold disabled:bg-gray-300 shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«è³‡æ–™</button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="user" className="text-indigo-600" /> è¯çµ¡è³‡è¨Š</h2>
                                <div className="space-y-4">
                                    <input placeholder="å§“å" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} />
                                    <input placeholder="è¯çµ¡é›»è©±" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" value={formData.phone} onChange={e=>setFormData({...formData, phone: e.target.value})} />
                                    <textarea placeholder="å‚™è¨»äº‹é …" className="w-full p-3 border rounded-xl h-24 focus:ring-2 focus:ring-indigo-500 outline-none" value={formData.note} onChange={e=>setFormData({...formData, note: e.target.value})} />
                                </div>
                                <div className="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                                    <div className="flex justify-between font-bold text-lg text-gray-800">
                                        <span>é è¨ˆæ‡‰ä»˜é‡‘é¡</span>
                                        <span className="text-indigo-600">${calculatePrice}</span>
                                    </div>
                                    <p className="text-xs text-indigo-400 mt-1">* æœ€çµ‚é‡‘é¡ä»¥ç®¡ç†å“¡æ ¸å°æ™‚æ®µç‚ºæº–</p>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={()=>setStep(1)} className="flex-1 bg-gray-100 py-4 rounded-xl font-bold text-gray-600 hover:bg-gray-200 transition-all">ä¸Šä¸€æ­¥</button>
                                    <button onClick={handleSubmit} className="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">ç¢ºèªä¸¦æäº¤ç™»è¨˜</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="bg-white rounded-2xl shadow-xl p-8 text-center animate-in">
                                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon name="check-circle" className="w-10 h-10 text-green-600" />
                                </div>
                                <h2 className="text-2xl font-bold mb-2 text-gray-800">ç™»è¨˜è³‡æ–™å·²é€å‡ºï¼</h2>
                                <p className="text-gray-600 mb-8">è«‹æ–¼ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ä»¥ä¿ç•™æ‚¨çš„æ™‚æ®µ</p>
                                <div className="bg-gray-50 p-6 rounded-2xl text-left space-y-4 mb-6 border border-gray-100">
                                    <h4 className="font-bold text-gray-700 border-b pb-2 flex items-center gap-2"><Icon name="credit-card" className="w-4 h-4" /> åŒ¯æ¬¾è³‡è¨Š</h4>
                                    <div className="grid grid-cols-2 gap-y-2 text-sm">
                                        <span className="text-gray-500">æˆ¶åï¼š</span><span className="font-bold text-gray-800">{BANK_INFO.name}</span>
                                        <span className="text-gray-500">éŠ€è¡Œï¼š</span><span className="font-bold text-gray-800">{BANK_INFO.bank}</span>
                                        <span className="text-gray-500">å¸³è™Ÿï¼š</span><span className="font-bold text-gray-800 tracking-wider">{BANK_INFO.account}</span>
                                        <span className="text-gray-500">é‡‘é¡ï¼š</span><span className="font-black text-indigo-600 text-lg">${calculatePrice}</span>
                                    </div>
                                </div>
                                <p className="text-xs text-gray-400 mb-8 px-4 leading-relaxed">{BANK_INFO.remind}</p>
                                <button onClick={()=>{setStep(1); setFormData({...formData, date:''})}} className="bg-gray-800 text-white px-10 py-3 rounded-full font-bold hover:bg-gray-900 transition-all">å›åˆ°é¦–é </button>
                            </div>
                        )}

                        <div className="mt-12">
                            <h3 className="font-bold text-gray-800 mb-4 px-2">æœ€è¿‘é ç´„æ¦‚æ³</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {bookings.filter(b => b.date >= new Date().toISOString().split('T')[0]).slice(0, 4).map(b => (
                                    <div key={b.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-gray-800">{b.date}</p>
                                            <p className="text-xs text-gray-500">{b.startTime} - {b.endTime} ({b.roomType})</p>
                                        </div>
                                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold ${b.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                                            {b.status === 'confirmed' ? 'å·²ç¢ºèª' : 'å·²è¢«é è¨‚'}
                                        </span>
                                    </div>
                                ))}
                                {bookings.length === 0 && <div className="col-span-full py-10 text-center text-gray-400 text-sm italic">ç›®å‰æš«ç„¡é ç´„è³‡æ–™</div>}
                            </div>
                        </div>
                    </main>
                    <footer className="mt-20 py-10 border-t border-gray-100 text-center text-gray-400 text-xs">
                        &copy; 2024 å˜ä¹‹çª©æ–‡å‰µç©ºé–“ Â· é ç´„ç®¡ç†ç³»çµ±
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

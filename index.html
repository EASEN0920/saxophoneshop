<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嘎之窩文創空間登記表</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for browser JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (Compat Version for easier browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase 配置 ---
        // 請在此填入您的 Firebase 專案資訊
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // 如果 config 是空的，嘗試從環境變數取得 (Canvas 模擬環境使用)
        const actualConfig = firebaseConfig.apiKey ? firebaseConfig : (window.__firebase_config ? JSON.parse(window.__firebase_config) : {});
        
        if (actualConfig.apiKey) {
            firebase.initializeApp(actualConfig);
        }
        
        const auth = firebase.auth?.();
        const db = firebase.firestore?.();
        const appId = "gazi-room-booking";

        const CLASSROOM_TYPES = {
            LARGE: '大教室',
            SMALL: '小教室'
        };

        const BANK_INFO = {
            name: "嘎之窩文創空間",
            bank: "台灣銀行 (004)",
            account: "123-456-789012",
            remind: "匯款後請提供帳號末五碼以利對帳。管理員確認匯款後，系統將自動寄發確認信並同步至日曆。"
        };

        // 圖示組件
        const Icon = ({ name, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [bookings, setBookings] = useState([]);
            const [step, setStep] = useState(1);
            const [message, setMessage] = useState(null);
            const [formData, setFormData] = useState({
                date: '',
                startTime: '09:00',
                endTime: '10:00',
                roomType: CLASSROOM_TYPES.LARGE,
                name: '',
                phone: '',
                note: ''
            });

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                    if (u) setFormData(prev => ({ ...prev, name: u.displayName || '' }));
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings')
                    .onSnapshot((snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBookings(data);
                    });
                return () => unsubscribe();
            }, [user]);

            const handleLogin = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    setMessage({ type: 'error', text: '登入失敗：' + error.message });
                }
            };

            const handleLogout = () => auth.signOut();

            const calculatePrice = useMemo(() => {
                if (!formData.date || !formData.startTime || !formData.endTime) return 0;
                const startHour = parseInt(formData.startTime.split(':')[0]);
                const endHour = parseInt(formData.endTime.split(':')[0]);
                const duration = endHour - startHour;
                if (duration <= 0) return 0;

                if (formData.roomType === CLASSROOM_TYPES.SMALL) return duration * 350;
                
                const dateObj = new Date(formData.date);
                const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                let total = 0;
                for (let h = startHour; h < endHour; h++) {
                    if (isWeekend) total += 600;
                    else total += (h < 17) ? 500 : 600;
                }
                return total;
            }, [formData]);

            const checkConflict = () => {
                return bookings.some(b => {
                    if (b.date !== formData.date || b.roomType !== formData.roomType) return false;
                    const newStart = parseInt(formData.startTime.replace(':', ''));
                    const newEnd = parseInt(formData.endTime.replace(':', ''));
                    const oldStart = parseInt(b.startTime.replace(':', ''));
                    const oldEnd = parseInt(b.endTime.replace(':', ''));
                    return (newStart < oldEnd && newEnd > oldStart);
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (checkConflict()) {
                    setMessage({ type: 'error', text: '該時段已被佔用，請重新選擇。' });
                    return;
                }
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('bookings').add({
                        ...formData,
                        userId: user.uid,
                        userEmail: user.email,
                        price: calculatePrice,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setStep(3);
                } catch (error) {
                    setMessage({ type: 'error', text: '提交失敗，請檢查資料庫權限設定。' });
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-indigo-600 font-bold">載入中...</div>;

            if (!user) return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center">
                        <Icon name="home" className="w-16 h-16 text-indigo-600 mx-auto mb-6" />
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">嘎之窩文創空間</h1>
                        <p className="text-gray-600 mb-8">請先登入 Google 帳號以開始預約教室</p>
                        <button onClick={handleLogin} className="w-full py-3 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-3 font-medium hover:bg-gray-50 transition-all">
                            <img src="https://www.google.com/favicon.ico" className="w-5 h-5" alt="Google" />
                            使用 Google 帳號登入
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    <nav className="bg-white shadow-sm p-4 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="home" className="w-6 h-6 text-indigo-600" />
                                <span className="font-bold text-xl">嘎之窩預約系統</span>
                            </div>
                            <button onClick={handleLogout} className="text-gray-500 hover:text-red-500 flex items-center gap-2">
                                <span className="hidden sm:inline text-sm">{user.displayName}</span>
                                <Icon name="log-out" className="w-5 h-5" />
                            </button>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto p-4 mt-8">
                        {/* 步驟指示 */}
                        <div className="flex justify-center mb-8 gap-4">
                            {[1, 2, 3].map(s => (
                                <div key={s} className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${step >= s ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-400'}`}>{s}</div>
                            ))}
                        </div>

                        {message && (
                            <div className="mb-4 p-4 rounded-xl bg-red-50 text-red-700 border border-red-200 flex items-center gap-2">
                                <Icon name="alert-circle" className="w-5 h-5" />
                                {message.text}
                            </div>
                        )}

                        {step === 1 && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="calendar" className="text-indigo-600" /> 選擇時段</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">日期</label>
                                        <input type="date" className="w-full p-3 border rounded-xl" min={new Date().toISOString().split('T')[0]} value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="block text-sm font-bold mb-2">開始</label>
                                            <select className="w-full p-3 border rounded-xl" value={formData.startTime} onChange={e => setFormData({...formData, startTime: e.target.value})}>
                                                {Array.from({length:14}, (_,i)=>i+8).map(h => <option key={h} value={`${h.toString().padStart(2,'0')}:00`}>{h}:00</option>)}
                                            </select>
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-sm font-bold mb-2">結束</label>
                                            <select className="w-full p-3 border rounded-xl" value={formData.endTime} onChange={e => setFormData({...formData, endTime: e.target.value})}>
                                                {Array.from({length:14}, (_,i)=>i+9).map(h => <option key={h} value={`${h.toString().padStart(2,'0')}:00`}>{h}:00</option>)}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={()=>setFormData({...formData, roomType: CLASSROOM_TYPES.LARGE})} className={`p-4 border-2 rounded-xl text-left ${formData.roomType === CLASSROOM_TYPES.LARGE ? 'border-indigo-600 bg-indigo-50' : 'border-gray-100'}`}>
                                        <p className="font-bold">大教室</p>
                                        <p className="text-xs text-gray-500">平日 $500/hr (17:00後及假日 $600/hr)</p>
                                    </button>
                                    <button onClick={()=>setFormData({...formData, roomType: CLASSROOM_TYPES.SMALL})} className={`p-4 border-2 rounded-xl text-left ${formData.roomType === CLASSROOM_TYPES.SMALL ? 'border-indigo-600 bg-indigo-50' : 'border-gray-100'}`}>
                                        <p className="font-bold">小教室</p>
                                        <p className="text-xs text-gray-500">均一價 $350/hr</p>
                                    </button>
                                </div>
                                <button disabled={!formData.date} onClick={()=>setStep(2)} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold disabled:bg-gray-300">下一步：聯絡資訊</button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="user" className="text-indigo-600" /> 聯絡資料</h2>
                                <div className="space-y-4">
                                    <input placeholder="姓名" className="w-full p-3 border rounded-xl" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} />
                                    <input placeholder="聯絡電話" className="w-full p-3 border rounded-xl" value={formData.phone} onChange={e=>setFormData({...formData, phone: e.target.value})} />
                                    <textarea placeholder="備註事項" className="w-full p-3 border rounded-xl h-24" value={formData.note} onChange={e=>setFormData({...formData, note: e.target.value})} />
                                </div>
                                <div className="p-4 bg-gray-50 rounded-xl">
                                    <div className="flex justify-between font-bold text-lg">
                                        <span>總計金額</span>
                                        <span className="text-indigo-600">${calculatePrice}</span>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={()=>setStep(1)} className="flex-1 bg-gray-100 py-4 rounded-xl font-bold">上一步</button>
                                    <button onClick={handleSubmit} className="flex-[2] bg-indigo-600 text-white py-4 rounded-xl font-bold">確認預約</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="bg-white rounded-2xl shadow-xl p-8 text-center animate-in">
                                <Icon name="check-circle" className="w-16 h-16 text-green-500 mx-auto mb-4" />
                                <h2 className="text-2xl font-bold mb-2">登記完成！</h2>
                                <p className="text-gray-600 mb-6">請於 24 小時內完成匯款以保留名額</p>
                                <div className="bg-indigo-50 p-6 rounded-2xl text-left space-y-3 mb-6">
                                    <p><b>戶名：</b>{BANK_INFO.name}</p>
                                    <p><b>銀行：</b>{BANK_INFO.bank}</p>
                                    <p><b>帳號：</b>{BANK_INFO.account}</p>
                                    <p className="text-indigo-600 font-bold text-xl">匯款金額：${calculatePrice}</p>
                                </div>
                                <p className="text-sm text-gray-500 mb-6">{BANK_INFO.remind}</p>
                                <button onClick={()=>{setStep(1); setFormData({...formData, date:''})}} className="bg-gray-800 text-white px-8 py-3 rounded-full">回到首頁</button>
                            </div>
                        )}

                        <div className="mt-12">
                            <h3 className="font-bold text-gray-800 mb-4">近期預約概況</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {bookings.filter(b => b.date >= new Date().toISOString().split('T')[0]).slice(0, 4).map(b => (
                                    <div key={b.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between">
                                        <div>
                                            <p className="font-bold text-gray-800">{b.date}</p>
                                            <p className="text-xs text-gray-500">{b.startTime} - {b.endTime} ({b.roomType})</p>
                                        </div>
                                        <span className="text-[10px] px-2 h-5 flex items-center bg-amber-100 text-amber-700 rounded-full font-bold">已預約</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
